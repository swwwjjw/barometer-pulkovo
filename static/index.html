<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Market Dashboard</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { margin: 0; color: #333; }
        select { padding: 10px; font-size: 16px; border-radius: 4px; border: 1px solid #ddd; min-width: 300px; }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .metric-box { background: #f8f9fa; padding: 15px; border-radius: 6px; text-align: center; border: 1px solid #e9ecef; }
        .metric-value { font-size: 24px; font-weight: bold; color: #2c3e50; }
        .metric-label { font-size: 14px; color: #6c757d; margin-top: 5px; }
        .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; }
        .chart-container { height: 400px; }
        .loading { text-align: center; padding: 50px; font-size: 18px; color: #666; }
        .error { color: #dc3545; padding: 20px; background: #f8d7da; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { 
            BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer,
            ScatterChart, Scatter, ZAxis, PieChart, Pie, Cell
        } = Recharts;

        const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#82ca9d'];

        function App() {
            const [titles, setTitles] = useState([]);
            const [selectedTitle, setSelectedTitle] = useState("");
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            useEffect(() => {
                fetch('/api/dashboard/titles')
                    .then(res => res.json())
                    .then(data => {
                        setTitles(data);
                        if (data.length > 0) setSelectedTitle(data[0]);
                    })
                    .catch(err => setError("Failed to load job titles"));
            }, []);

            useEffect(() => {
                if (!selectedTitle) return;

                setLoading(true);
                fetch(`/api/dashboard/stats/${encodeURIComponent(selectedTitle)}`)
                    .then(res => res.json())
                    .then(data => {
                        setData(data);
                        setLoading(false);
                    })
                    .catch(err => {
                        setError("Failed to load stats");
                        setLoading(false);
                    });
            }, [selectedTitle]);

            if (error) return <div className="container error">{error}</div>;

            return (
                <div className="container">
                    <div className="header">
                        <h1>Job Market Dashboard</h1>
                        <select 
                            value={selectedTitle} 
                            onChange={(e) => setSelectedTitle(e.target.value)}
                            disabled={loading}
                        >
                            {titles.map(t => <option key={t} value={t}>{t}</option>)}
                        </select>
                    </div>

                    {loading && <div className="loading">Loading data...</div>}

                    {!loading && data && (
                        <div>
                            <div className="metrics-grid">
                                <div className="metric-box">
                                    <div className="metric-value">{data.salary_stats.min.toLocaleString()} ₽</div>
                                    <div className="metric-label">Min Salary</div>
                                </div>
                                <div className="metric-box">
                                    <div className="metric-value">{data.salary_stats.avg.toLocaleString()} ₽</div>
                                    <div className="metric-label">Average Salary</div>
                                </div>
                                <div className="metric-box">
                                    <div className="metric-value">{data.salary_stats.median.toLocaleString()} ₽</div>
                                    <div className="metric-label">Median Salary</div>
                                </div>
                                <div className="metric-box">
                                    <div className="metric-value">{data.salary_stats.max.toLocaleString()} ₽</div>
                                    <div className="metric-label">Max Salary</div>
                                </div>
                            </div>

                            <div className="chart-grid">
                                <div className="card">
                                    <h3>Salary vs Employer Rating</h3>
                                    <div className="chart-container">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <ScatterChart margin={{ top: 20, right: 20, bottom: 20, left: 20 }}>
                                                <CartesianGrid />
                                                <XAxis type="number" dataKey="rating" name="Rating" domain={[0, 5]} unit="" label={{ value: 'Rating', position: 'insideBottom', offset: -10 }} />
                                                <YAxis type="number" dataKey="salary" name="Salary" unit="₽" label={{ value: 'Salary', angle: -90, position: 'insideLeft' }} />
                                                <Tooltip cursor={{ strokeDasharray: '3 3' }} />
                                                <Scatter name="Vacancies" data={data.salary_rating_data} fill="#8884d8" />
                                            </ScatterChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>

                                <div className="card">
                                    <h3>Pulkovo vs Market Average</h3>
                                    <div className="chart-container">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <BarChart
                                                data={[
                                                    { name: 'Market Avg', salary: data.market_salary_avg },
                                                    { name: 'Pulkovo', salary: data.pulkovo_salary || 0 }
                                                ]}
                                                margin={{ top: 5, right: 30, left: 20, bottom: 5 }}
                                            >
                                                <CartesianGrid strokeDasharray="3 3" />
                                                <XAxis dataKey="name" />
                                                <YAxis />
                                                <Tooltip />
                                                <Legend />
                                                <Bar dataKey="salary" fill="#82ca9d" name="Monthly Salary (₽)" />
                                            </BarChart>
                                        </ResponsiveContainer>
                                    </div>
                                    {!data.pulkovo_salary && <p style={{textAlign: 'center', color: '#666'}}>No data for Pulkovo for this role.</p>}
                                </div>

                                <div className="card">
                                    <h3>Salary Distribution</h3>
                                    <div className="chart-container">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <BarChart
                                                data={data.salary_distribution}
                                                margin={{ top: 5, right: 30, left: 20, bottom: 5 }}
                                            >
                                                <CartesianGrid strokeDasharray="3 3" />
                                                <XAxis dataKey="range" />
                                                <YAxis />
                                                <Tooltip />
                                                <Bar dataKey="count" fill="#8884d8" name="Vacancies" />
                                            </BarChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>

                                <div className="card">
                                    <h3>Experience Distribution</h3>
                                    <div className="chart-container">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <PieChart>
                                                <Pie
                                                    data={data.experience_distribution}
                                                    cx="50%"
                                                    cy="50%"
                                                    labelLine={false}
                                                    label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
                                                    outerRadius={120}
                                                    fill="#8884d8"
                                                    dataKey="value"
                                                >
                                                    {data.experience_distribution.map((entry, index) => (
                                                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                                    ))}
                                                </Pie>
                                                <Tooltip />
                                            </PieChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
